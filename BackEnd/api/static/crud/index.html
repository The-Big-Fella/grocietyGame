<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grociety | Admin CRUD</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --sidebar-width: 260px;
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --bg: #f8f9fd;
            --card-bg: #ffffff;
            --text-main: #2b2d42;
            --text-muted: #8d99ae;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; background: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* Sidebar */
        aside { width: var(--sidebar-width); background: var(--primary); color: white; padding: 2rem 1rem; display: flex; flex-direction: column; gap: 2rem; }
        .logo { font-size: 1.5rem; font-weight: 800; display: flex; align-items: center; gap: 10px; padding-left: 10px; }
        nav { display: flex; flex-direction: column; gap: 5px; }
        nav button { background: none; border: none; color: rgba(255,255,255,0.7); padding: 12px 15px; text-align: left; cursor: pointer; border-radius: 8px; font-weight: 500; transition: 0.3s; display: flex; align-items: center; gap: 10px; width: 100%; }
        nav button.active { background: rgba(255,255,255,0.2); color: white; }
        nav button:hover { background: rgba(255,255,255,0.1); color: white; }

        /* Main Content */
        main { flex: 1; padding: 2rem; overflow-y: auto; }
        header { margin-bottom: 2rem; }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & Forms */
        .card { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 1rem; }
        
        label { display: block; margin-bottom: 8px; font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
        input, select { width: 100%; padding: 10px; border: 1px solid #e0e4e9; border-radius: 8px; box-sizing: border-box; }
        
        .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-edit { background: #e0f2fe; color: var(--primary); }
        .btn-edit:hover { background: var(--primary); color: white; }

        /* Tables */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #f0f2f5; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f0f2f5; font-size: 0.9rem; }
        .actions { display: flex; gap: 8px; }

        .status-popup { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; display: none; z-index: 1000; font-weight: 600; }
    </style>
</head>
<body>

<aside>
    <div class="logo"><i class="fas fa-database"></i> GROCIETY DB</div>
    <nav>
        <button onclick="switchTab('events')" class="tab-btn active" id="btn-events"><i class="fas fa-calendar"></i> Events</button>
        <button onclick="switchTab('rounds')" class="tab-btn" id="btn-rounds"><i class="fas fa-layer-group"></i> Rounds</button>
        <button onclick="switchTab('questions')" class="tab-btn" id="btn-questions"><i class="fas fa-question-circle"></i> Questions</button>
    </nav>
</aside>

<main>
    <div id="statusPopup" class="status-popup"></div>

    <div id="events" class="tab-content active">
        <header><h1>Event Management</h1></header>
        <div class="card">
            <h2>Add New Event</h2>
            <form id="eventForm" class="form-grid">
                <div><label>NAME</label><input type="text" id="eventName" required></div>
                <div style="display:flex; align-items:flex-end;"><button type="submit" class="btn btn-primary">Create</button></div>
            </form>
        </div>
        <div class="card">
            <h2>Existing Events</h2>
            <table id="eventTable">
                <thead><tr><th>ID</th><th>Event Name</th><th>Actions</th></tr></thead>
                <tbody id="eventTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="rounds" class="tab-content">
        <header><h1>Round Management</h1></header>
        <div class="card">
            <h2>Add New Round</h2>
            <form id="roundForm" class="form-grid">
                <div><label>EVENT</label><select id="roundEventSelect" required></select></div>
                <div><label>ROUND #</label><input type="number" id="roundNumber" required></div>
                <div style="display:flex; align-items:flex-end;"><button type="submit" class="btn btn-primary">Add Round</button></div>
            </form>
        </div>
        <div class="card">
            <h2>Existing Rounds</h2>
            <table>
                <thead><tr><th>ID</th><th>Event</th><th>Round #</th><th>Actions</th></tr></thead>
                <tbody id="roundTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="questions" class="tab-content">
        <header><h1>Question Bank</h1></header>
        <div class="card">
            <h2>New Question</h2>
            <form id="questionForm">
                <div class="form-grid">
                    <div><label>ROUND</label><select id="questionRoundSelect" required></select></div>
                    <div><label>TYPE</label><select id="questionType" required>
                        <option value="1">Choice</option><option value="2">Action</option>
                    </select></div>
                    <div style="grid-column: span 2;"><label>TEXT</label><input type="text" id="questionText" required></div>
                </div>
                <div class="form-grid">
                    <div><label>BUDGET</label><input type="number" id="budget" required></div>
                    <div><label>MOOD</label><input type="number" id="mood" required></div>
                    <div style="display:flex; align-items:flex-end; grid-column: span 2;">
                        <button type="submit" class="btn btn-primary" style="width:100%">Save Question</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="card">
            <table>
                <thead><tr><th>ID</th><th>Round</th><th>Type</th><th>Text</th><th>Budget</th><th>Mood</th><th>Actions</th></tr></thead>
                <tbody id="questionTableBody"></tbody>
            </table>
        </div>
    </div>
</main>

<script>
    const API_BASE = '/api';

    // NAVIGATION
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.getElementById('btn-' + tabId).classList.add('active');
    }

    function showPopup(msg, isErr = false) {
        const p = document.getElementById('statusPopup');
        p.innerText = msg;
        p.style.display = 'block';
        p.style.background = isErr ? '#f72585' : '#4cc9f0';
        setTimeout(() => p.style.display = 'none', 3000);
    }

    // GENERIC CRUD CALLER
    async function apiAction(endpoint, method = 'GET', data = null) {
        const options = { method, headers: {'Content-Type': 'application/json'} };
        if (data) options.body = JSON.stringify(data);
        const res = await fetch(`${API_BASE}${endpoint}`, options);
        if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.error || 'Server error');
        }
        return res.json();
    }

    // REFRESH ALL TABLES
    async function refreshAll() {
        try {
            const events = await apiAction('/events');
            const rounds = await apiAction('/rounds');
            const questions = await apiAction('/questions');
            console.log(questions)

            // Render Events
            document.getElementById('eventTableBody').innerHTML = events.map(e => `
                <tr>
                    <td>${e.id}</td>
                    <td>${e.name}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-edit" onclick="editItem('events', ${e.id}, '${e.name}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem('events', ${e.id})">Delete</button>
                    </td>
                </tr>
            `).join('');

            // Render Rounds
            document.getElementById('roundTableBody').innerHTML = rounds.map(r => `
                <tr>
                    <td>${r.id}</td>
                    <td>ID: ${r.event_id}</td>
                    <td>${r.round_number}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-danger" onclick="deleteItem('rounds', ${r.id})">Delete</button>
                    </td>
                </tr>
            `).join('');

            // Render Questions
            console.log(questions)
            document.getElementById('questionTableBody').innerHTML = questions.map(q => `
                <tr>
                    <td>${q.id}</td>
                    <td>${q.round_id}</td>
                    <td>${q.type_name}</td>
                    <td>${q.text}</td>
                    <td>${q.budget}</td>
                    <td>${q.mood}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-danger" onclick="deleteItem('questions', ${q.id})">Delete</button>
                    </td>
                </tr>
            `).join('');

            // Update Dropdowns
            document.getElementById('roundEventSelect').innerHTML = events.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            document.getElementById('questionRoundSelect').innerHTML = rounds.map(r => `<option value="${r.id}">Round ${r.round_number} (ID: ${r.id})</option>`).join('');

        } catch (err) { console.error(err); }
    }

    // ACTIONS
    async function deleteItem(type, id) {
        if (!confirm(`Are you sure you want to delete this ${type.slice(0,-1)}?`)) return;
        try {
            await apiAction(`/${type}/${id}`, 'DELETE');
            showPopup('Deleted successfully');
            refreshAll();
        } catch (err) { showPopup(err.message, true); }
    }

    async function editItem(type, id, currentName) {
        const newName = prompt(`Enter new name for ${type.slice(0,-1)}:`, currentName);
        if (!newName || newName === currentName) return;
        try {
            await apiAction(`/${type}/${id}`, 'PUT', { name: newName });
            showPopup('Updated successfully');
            refreshAll();
        } catch (err) { showPopup(err.message, true); }
    }

    // FORM HANDLERS
    document.getElementById('eventForm').onsubmit = async (e) => {
        e.preventDefault();
        try {
            await apiAction('/events', 'POST', { name: document.getElementById('eventName').value });
            document.getElementById('eventName').value = '';
            showPopup('Event Created!');
            refreshAll();
        } catch(err) { showPopup(err.message, true); }
    };

    document.getElementById('roundForm').onsubmit = async (e) => {
        e.preventDefault();
        try {
            await apiAction('/rounds', 'POST', {
                event_id: parseInt(document.getElementById('roundEventSelect').value),
                round_number: parseInt(document.getElementById('roundNumber').value)
            });
            showPopup('Round Added!');
            refreshAll();
        } catch(err) { showPopup(err.message, true); }
    };

    document.getElementById('questionForm').onsubmit = async (e) => {
        e.preventDefault();
        try {
            await apiAction('/questions', 'POST', {
                round_id: parseInt(document.getElementById('questionRoundSelect').value),
                type_id: parseInt(document.getElementById('questionType').value),
                text: document.getElementById('questionText').value,
                budget: parseInt(document.getElementById('budget').value),
                mood: parseInt(document.getElementById('mood').value)
            });
            document.getElementById('questionText').value = '';
            showPopup('Question Saved!');
            refreshAll();
        } catch(err) { showPopup(err.message, true); }
    };

    refreshAll();
</script>
</body>
</html>
